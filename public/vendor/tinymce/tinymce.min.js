(function(){
  const style = document.createElement('style')
  style.textContent = `
  .tiny-host{border:1px solid #1b2a4a;border-radius:10px;background:#0a1325;box-shadow:0 6px 22px rgba(0,0,0,.35);width:100%;}
  .tiny-toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:6px;border-bottom:1px solid #1b2a4a;background:rgba(255,255,255,0.03);}
  .tiny-btn{background:#0f1a2e;color:#e7eefc;border:1px solid #1b2a4a;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px;}
  .tiny-btn:hover{background:rgba(110,231,255,0.08);}
  .tiny-area{min-height:240px;padding:10px;color:#e7eefc;outline:none;white-space:pre-wrap;}
  `
  document.head.appendChild(style)

  const COMMAND_MAP = {
    bold: () => document.execCommand('bold'),
    italic: () => document.execCommand('italic'),
    underline: () => document.execCommand('underline'),
    bullist: () => document.execCommand('insertUnorderedList'),
    numlist: () => document.execCommand('insertOrderedList'),
    alignleft: () => document.execCommand('justifyLeft'),
    aligncenter: () => document.execCommand('justifyCenter'),
    alignright: () => document.execCommand('justifyRight'),
    undo: () => document.execCommand('undo'),
    redo: () => document.execCommand('redo'),
    removeformat: () => document.execCommand('removeFormat')
  }

  function TinyEditor(textarea, opts) {
    this.textarea = textarea
    this.opts = opts || {}
    this.host = document.createElement('div')
    this.host.className = 'tiny-host'
    this.toolbar = document.createElement('div')
    this.toolbar.className = 'tiny-toolbar'
    this.area = document.createElement('div')
    this.area.className = 'tiny-area'
    this.area.contentEditable = 'true'
    this.area.style.minHeight = (this.opts.height || 280) + 'px'

    if (textarea) {
      this.setContent(textarea.value || '')
      textarea.style.display = 'none'
      textarea.insertAdjacentElement('afterend', this.host)
    }

    this.host.appendChild(this.toolbar)
    this.host.appendChild(this.area)
    this.buildToolbar(this.opts.toolbar || '')
  }

  TinyEditor.prototype.buildToolbar = function(toolbarStr) {
    const labels = {
      bold: 'Bold', italic: 'Italic', underline: 'Underline',
      bullist: 'â€¢ List', numlist: '1. List', alignleft: 'Left', aligncenter: 'Center', alignright: 'Right',
      undo: 'Undo', redo: 'Redo', removeformat: 'Clear'
    }
    const commands = toolbarStr.replace(/\|/g, ' ').split(' ').filter(Boolean)
    commands.forEach(cmd => {
      if (!labels[cmd]) return
      const btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'tiny-btn'
      btn.textContent = labels[cmd]
      btn.addEventListener('click', () => {
        if (COMMAND_MAP[cmd]) COMMAND_MAP[cmd]()
        this.sync()
      })
      this.toolbar.appendChild(btn)
    })
  }

  TinyEditor.prototype.sync = function() {
    if (this.textarea) this.textarea.value = this.getContent({ format: 'html' })
  }

  TinyEditor.prototype.setContent = function(html) {
    this.area.innerHTML = html || ''
    this.sync()
  }

  TinyEditor.prototype.getContent = function(opts) {
    if (opts && opts.format === 'text') return this.area.innerText || ''
    return this.area.innerHTML || ''
  }

  TinyEditor.prototype.remove = function() {
    if (this.textarea) {
      this.textarea.style.display = ''
      this.textarea.value = this.getContent({ format: 'text' })
    }
    if (this.host.parentNode) this.host.parentNode.removeChild(this.host)
  }

  window.tinymce = {
    init: function(opts) {
      return new Promise((resolve, reject) => {
        const el = document.querySelector(opts.selector)
        if (!el) return reject(new Error('TinyMCE target not found'))
        const inst = new TinyEditor(el, opts || {})
        resolve([inst])
      })
    }
  }
})()
